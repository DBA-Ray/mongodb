#!/bin/bash

backup_time=`date "+%Y%m%d_%H%M%S"`

delete_time=`date +%H%M%S`

clustername={{ clustername }}

hostname={{ inventory_hostname_short }}

backupdir={{ backupdir }}

monitor={{ monitordir }}/mongodb_hotbackup_status.txt

shelldir={{ shelldir }}

logdir="$backupdir/mongodb_consistent_backup_log"

dingding_url="https://oapi.dingtalk.com/robot/send?access_token=f333b3f832ac4e91f7906acb35eabbb538595e440c68b69cd71a25197509d509"

#向钉钉发送消息方法
function SendMessageToDingding()
{ # 发送钉钉消息
Dingding_Url="${dingding_url}" 
curl "${Dingding_Url}" -H 'Content-Type: application/json' -d "
 { \"msgtype\":\"text\",
\"text\":{
\"content\":\"${1}\"},
\"at\":{
\"atMobiles\":[\"15668661298\"],
\"isAtAll\":false} }"
}

function check_status()

{

    status=`cat ${1}|grep "successfully"|wc -l`

    if [ $status -eq 1 ]

    then

        ##success backup status

        echo 1 > ${monitor}

    else

        ##fail backup status

        echo 0 > ${monitor}

        SendMessageToDingding "MongoDB Cluster(${hostname})逻辑备份失败，请及时查看备份日志！"

    fi

}

clean() {

#find ${backupdir}/${clustername}/ -type d -mtime +7 -name "2.*" -exec rm -rf {} \;

find ${backupdir}/ -type f -mtime +7 -name "2.*"  -exec rm -rf {} \;

}

mongodb-consistent-backup --config ${shelldir}/mongodb-consistent-backup.yml >> ${backupdir}/${backup_time}.log

check_status ${backupdir}/${backup_time}.log

if [ ${delete_time} == 030001  ]

then

clean

fi
